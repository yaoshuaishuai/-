## 背景及目的

### 现状分析

​		在项目后期执行过程中，我本人发现重要系统发布都以文件替换的形式发布（不敢整体替换程序包）。主要原因是团队在使用git时并不规范，未形成规范的适合团队的git工作流，导致分支使用随便，源代码管理混乱。总结git使用问题如下：

| 问题     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 分支规划 | 在系统开发阶段，开发人员并未注重源码是在哪个分支上进行开发，有很多时候代码都开始改动了，才发现分支不对，将其修改的代码进行拷贝，还原本地分支后再切换分支或者重新创建分支，再拷贝代码 |
| 分支命名 | 分支命名有系统版本名称的，有纯英文的，也有单是一个版本号的... 分支命名应该见明知意 |
| 分支使用 | 自定义master分支：一个git下存放多个系统的源码，且master受保护，代码提交受阻。协同页面拉出一个自己的develop分支作为maser进行开发了，发布后的源码也不往master分支合并了，需要发布补丁版本也是直接从，develop上直接拉分支 |
| 分支合并 | 开人员测试时都是自己本地环境打包，测试完成后也不注重代码合并，导致自己开发的功能就在自己的分支上放着，但master分支并未包含该功能的代码，导致该功能上线，项目重新发布，从master构建出来的程序包就会缺失功能<br />分析主要两点原因：<br />①分支合并master需要提交和并请求，并没有指定提交给谁，自己又合并布上去<br />②先完成其他工作，合并分支简单，只要分支在源码就在，什么时间合并都行 |
| 分支删除 | 开发人员在合并分支的时候潜意识给你自留有余地，合并后不删除原有分支，出现缺陷后好快速找到代码，但造成git分支过多，文件夹越来越大 |
| tag创建  | ①在版本发布后，开发人员或者开发负责人没有意识去创建tag；<br />②创建tag的命名方式较乱，有全是英文的，全是汉字的，英文+字符的，从名字上并不能快速获取有用的信息 |

### 目标

​		针对以上出现的问题，编写《版本研发过程中git使用规范》来规范团队中开发人员对git的使用，从而约束成一种习惯，在团队内部逐渐形成适合团队开发人员开展工作的git工作流。

​		注：①适用于项目各系统各研发(如有特殊情况无法遵守，需要申请）

​				②不熟悉gitflow模型的开发人员可参考《gitflow介绍篇》进行简单了解



git创建









## 3.1 Git中央仓库生成

Git中央仓库由公司统一管理，想要初始化一个git仓库，请联系公司配置管理组成员申请git仓库，申请时提供项目信息及研发经理，以供配置管理对git仓库的管理。

## 3.2 资源定义

针对项目群，系统较多，发布版本较多的情况下，怎么来划分Git，是使用一个Git来管理所有系统源码？还是单个系统单个Git?

 

提供两种选择（可参考Visio中Git资源）：

1.一个系统一个源码。

优点：职责单一，git源码对于单个系统来说管理也简单方便，分支也清晰。

缺点：从经验来说一般一个项目涉及到的都是多个系统，创建多个git，管理人员可能管理比较费劲。 

2.一个git多个系统源码

优点：项目管理人员源码对外输出统一

缺点：一个git多个系统，在研发过程中，分支较多，命名不规范，导致哪个分支是为哪个系统开发的不清晰。

我避免分支清晰，可基于master创建多个develop,每个系统之后的开发都基于各自的develop创建功能或者版本分支。

 

## 3.3 Git管理

## 3.4 Git干系人管理

### 3.4.1       Git角色介绍：

gitlab中设置5种角色，各角色对应的权限也不同

Guest:访客。能够提问题。

Report：报告者。在Guest功能下增加下载工程，更新代码的功能等

Developer：开发者。在Report功能下新增创建分支，提交到非保护分支，创建wiki及tag的功能等。

Maintainer:管理者。在Developer功能下新增添加项目成员、设置/移除分支保护、提交到保护分支、修改/移除tag等。一般拥有Maintainer角色的为负责人、主程序员或者研发经理

Owner: 属于git资源的拥有者，拥有全部功能。一般为owner角色的为配置管理组成员。

详情看《角色权限》

### 3.4.2       Git人员添加

由申请者向主成人员或者负责人（拥有maintainer角色的人）进行申请加入git资源

主成人员或者负责人在人员在Settings->Members中搜索账号或域名设置角色并添加后通知申请人。

### 3.4.3       Develop分支创建

一般初始化后的git后，仓库远程端只有一个分支为master分支。可基于master分支创建一个新的分支，名称为Develop分支，之后所有功能分支基于Develop分支创建feature。

此过程最好是一个主程序员和系统负责人进行，需要进行如下步骤

1.创建develop分支；

2.将master分支设置为受保护分支。

关于保护分支的设置，可以进入Settings->Repository->Protected branches进行管理

 

# 4   操作流程[[11\]](#_msocom_11) [[12\]](#_msocom_12) 

以具体的项目开发流程为例，从系统需求，功能实现，软件测试，实施运维四个阶段，展示各分支的生命周期和活动状态

## 4.1 需求阶段[[13\]](#_msocom_13) 

需求阶段git操作只是提前进行git分支的规划及分支创建，未涉及代码层级的变动，一般git提交及活动量极小

### 4.1.1       Git开发模型选定[[14\]](#_msocom_14) 

在需求传递后，根据工作量大小，选定git分支模型

选定模型方式：1. 由研发经理或者主成人员决定分支模型；2. 研发内部达成一致，选定模型。

### 4.1.2       Git功能分支/版本分支创建[[15\]](#_msocom_15) 

基于develop分支创建新的分支，分支命名规则为：

1.如果是基于功能模型，创建分支以develop为基础，feature_功能名称首字母简写命名分支。

例如：涉案此物功能的分支创建为：feature_sacw

\2. 如果是基于版本模型，创建分支以develop为基础，feature_版本发布名称命名。

例如：协同办案子系统V1.0分支创建为：feature_协同办案子系统v1.0

 

注：1.创建分支前下拉取中央仓库最新代码到本地再创建分支2.创建分支不论是那种模式，分支命名规则统一。分支中间分隔符为下划线_ 所有字母均为小写。

 

## 4.2 开发阶段[[16\]](#_msocom_16) 

在功能发开工程中，代码每天不断更新，本地和中央仓库不断进行代码同步，此阶段是git最为活跃的时间段。Git使用最为频繁的操作为：拉取，提交 推送操作。

### 4.2.1       Git分支切换

功能分支/版本分支创建成功后，更新本地代码至最新，本地检出至4.1.2中切换的分支。该功能/版本分支分支贯穿整个阶段。

### 4.2.2       Jenkins自动化构建分支配置[[17\]](#_msocom_17) 

在系统功能或者版本开发完成后，提交本地最新代码至中央仓库，

配置自动化构建，统一交给jenkins打包处理，在构建配置时需要配置成对应的功能或者版本的分支。

### 4.2.3       Sonar静态代码检查分支配置

Jekins构建配置中sonar地址配置成公司sonar地址，检查分支需要配置成当前对应的功能或者版本分支，点击构建。

构建完成邮件中静态代码检查结果地址需要修改配置成jenkins构建成功后，需要查看控制台日中的构建结果，找到sonar地址（此地址具有分支信息），更改jenkis中配置完成中的sonar邮件地址。

注：每天至少进行一次本地和远程代码的同步，减少冲突，也避免长时间未更新代码导致代码丢失的情况[[18\]](#_msocom_18) 

## 4.3 测试阶段[[19\]](#_msocom_19) 

### 4.3.1       功能分支：

如果采用功能模型的分支进行开发，在功能测试完成后，稳定测试开始前进行如下操作：

a)     合并分支至develop，[[20\]](#_msocom_20) 在各功能测试完成后，需要将其完成测试的所有功能分支进行合并，将其没有问题的功能分支别分合并到develop上。

b)     删除该功能分支

c)     所有功能开发人员合并完成后通知系统发布及提测人员，提测人员同步代码至最新，

基于develop创建新的release分支

分支名称统一命名为：release_系统发布名称，例如：release_协同办案子系统1.0 

注：1.创建release分支确保两件事，第一：是否本次发布的所有功能均已经合并到develop，第二：本版本发布是基于哪个分支发布，基础版本的代码是否已经合并到develop2.分支名称中间分隔符为下划线_ 所有字母均为小写

d)     配置新创建的release分支上的jenkins构建和sonar代码检查

e)     在稳定测试后，将其release分支同步合并到master分支和develop分支。

如果合并分支人员不是mainiater角色

1.本地更新代码至最新，本地合并，并解决冲突。2.提交和并请求至主成或者负责人3.负责人或主成同意和并请求，代码自动合并。4.合并成功后，删除release分支。

f)     创建tag标签，标签命名规则：系统发布名称。例如：协同办案子系统V1.0。方便之后快速定位版本。

### 4.3.2       版本分支：

如果采用版本分支模型的话，从功能开发到版本发布，都一直沿用这一个分支，但各阶段还是需要进行检查。

a)     基础版本检查：在测试前，需要确认本版本发布是基于哪个分支发布，该分支是否在基础版本的分支合并之后打出的版本分支。如果是在基础版本合并之前打出的版本分支，则需要将develop分支/基础版本分支内容重新合并到本分支，然后进行测试。

b)     自动化构建和静态代码检查配置：提测前进行jenkins的分支配置和sonar的分支配置。

c)     分支合并：在功能测试和稳定测试完成后将版本分支代码合并到masters和develop上。

如果合并分支人员不是mainiater角色

1.本地更新代码至最新，本地合并，并解决冲突。2.提交和并请求至主成或者负责人3.负责人或主成同意和并请求，代码自动合并。

d)     合并成功后，删除版本分支。

e)     创建tag标签，标签命名规则：系统发布名称。例如：协同办案子系统V1.0。方便之后快速定位版本。

## 4.4 运维保障阶段[[21\]](#_msocom_21) 

如果上线后出现功能缺陷，则需要进行补丁修复。

a)     基于线上版本号，锁定tag标签。

b)     根据tag标签，回滚master分支到指定tag版本。

c)     基于回滚后的master创建补丁修复分支，命名规则为gotfix_协同办案子系统v1.0_build+序号。gotfix_协同办案子系统v1.0_build_001

d)     修改问题及测试全基于当前分支进行，缺陷解决后，将hotfix分支合并至master和develop分支上。

e)     合并成功后，删除缺陷分支。

f)     创建新的tag，标签命名规则：系统发布名称_bulid+序号。例如：协同办案子系统v1.0_bulid001，方便之后快速定位版本。

 

------



\1.     总结git使用的常见问题

\2.     目的单独提出一个章节目标与范围

 规范版本研发过程的git使用

 适用于项目各系统各研发(如有特殊情况无法遵守，需要申请)



这块不属于规范，属于git基础介绍



拼错了



图和下面分支介绍合并，一起介绍



各分支做目录导航。

\1.     先解释分支是做什么的，再介绍分支特点，

分支个数，怎么创建，谁创建或操作，通过此分支可以创建哪个分支



包含已发布的各版本的源码。

①项目创建时，会自动创建master分支，有且只有1个， 始终不删除；

②不能直接在master分支上做修改；

③master分支的更新来自于release或hotfix分支合并；

④master分支只能由主程序员操作



主开发分支。包含本版本已经开发完成，准备提测的代码。

①主程序员创建，有且只有1个。 始终不删除②develop分支上可以直接修改，可以合并其他分支

③基于develop分支可以创建feature分支



主要是用来开发一个新功能。一旦开发完成，合并到develop分支后，该分支删除



全部测试过的代码，为本版本发布准备的分支。基于develop分支创建，完成release后，合并到master和develop分支



Git创建

根据项目情况进行创建，项目前期确定

 根据项目规模，定制系统的数量，关联性，复杂度等综合确定

 源码git和文档git分开

(1)    小项目尽量一个项目里面所有的系统源码放一起，方便管理

(2)    大项目，根据各系统的关联性，复杂度和规模来划分多个git

(3)    协同产品在项目中定制开发的东西放到项目git，不能使用拷贝产品源码的方式

——项目中使用产品源码的方式，后面会专题讨论



这部分属于git分支管理规范



## 1.1    1.项目创建阶段

(1)develop分支创建

-主程序员，基于master分支，创建develop分支

-锁定master分支，不允许开发人员直接提交代码

-确定git角色

版本开发



确定开发分支及git角色



1.新功能，`开发工作量<=3人天的`，可直接在develop分支上修改。

2.>3天的，必须创建分支



feature分支的命名要能体现功能特性

命名规范为：`【feature/``系统``版本_功能特性】`

`——统一命名规范```



重点说明下提测

分支创建，分支命名，分支合并，分支使用



确定下什么时间做这个事？



\- `当develop上相同模块有改动时，开发人员可基于develop有选择性的合并`。

\- 涉及到新增表或字段的，feature分支使用本地的开发环境。待合并到develop时，需要在公用开发环境更新，并通知其他人员。---尽量避免



拆分为初测，稳定版测试和发布

\1.     初测：使用哪个分支测试

\2.     稳定版测试



合并到develop分支时，需要`概要描述下功能信息以及更新注意事项，特别是涉及到表和字段变动的要说明`



拆分为大步骤：

分支创建，分支命名，分支合并，分支使用

