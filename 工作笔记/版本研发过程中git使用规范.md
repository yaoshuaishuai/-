## 背景及目的

### 现状分析

​		在项目后期执行过程中，我本人发现重要系统发布都以文件替换的形式发布（不敢整体替换程序包）。主要原因是团队在使用git时并不规范，未形成规范的适合团队的git工作流，导致分支使用随便，源代码管理混乱。总结git使用问题如下：

| 问      题 | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| 分支规划   | 在系统开发阶段，开发人员并未注重源码是在哪个分支上进行开发，有很多时候代码都开始改动了，才发现分支不对，将其修改的代码进行拷贝，还原本地分支后再切换分支或者重新创建分支，再拷贝代码 |
| 分支命名   | 分支命名有系统版本名称的，有纯英文的，也有单是一个版本号的... 分支命名应该见明知意 |
| 分支使用   | 自定义master分支：一个git下存放多个系统的源码，且master受保护，代码提交受阻。协同页面拉出一个自己的develop分支作为maser进行开发了，发布后的源码也不往master分支合并了，需要发布补丁版本也是直接从，develop上直接拉分支 |
| 分支合并   | 开人员测试时都是自己本地环境打包，测试完成后也不注重代码合并，导致自己开发的功能就在自己的分支上放着，但master分支并未包含该功能的代码，导致该功能上线，项目重新发布，从master构建出来的程序包就会缺失功能<br />分析主要两点原因：<br />①分支合并master需要提交和并请求，并没有指定提交给谁，自己又合并布上去<br />②先完成其他工作，合并分支简单，只要分支在源码就在，什么时间合并都行 |
| 分支删除   | 开发人员在合并分支的时候潜意识给你自留有余地，合并后不删除原有分支，出现缺陷后好快速找到代码，但造成git分支过多，文件夹越来越大 |
| tag创建    | ①在版本发布后，开发人员或者开发负责人没有意识去创建tag；<br />②创建tag的命名方式较乱，有全是英文的，全是汉字的，英文+字符的，从名字上并不能快速获取有用的信息 |

### 目标

​		针对以上出现的问题，编写《版本研发过程中git使用规范》来规范团队中开发人员对git的使用，从而约束成一种习惯，在团队内部逐渐形成适合团队开发人员开展工作的git工作流。

​		注：①适用于项目各系统各研发(如有特殊情况无法遵守，需要申请）

​				②不熟悉gitflow模型的开发人员可参考《gitflow介绍篇》进行简单了解。

## git初始化

​		在申请git时，先简单介绍一下gitlab中的5中角色，及各角色对应的权限

| 角色       | 权限                                                         | 对应人员               |
| ---------- | ------------------------------------------------------------ | ---------------------- |
| guest      | 可以创建issue、发表评论，不能读写版本库                      |                        |
| report     | 可以克隆源代码，但不能提交                                   | 项目经理               |
| develop    | 可以克隆源代码、进行开发、提交、推送非保护分支到中央仓库；可以自行创建分支；创建tag标签等权限 | 开发人员               |
| maintainer | 创建项目、添加tag、设置保护分支、添加项目成员、编辑项目，同意分支合并 | 研发经理或者系统负责人 |
| owner      | 可以设置项目访问权限、删除项目、迁移项目、管理组成员         | 配置管理员             |

### git仓库申请（创建）

​		①确定项目需要git个数：在项目前期，根据项目的规模、系统的数量、系统间的关联性、复杂度等综合确定git资源申请数量。项目源代码git和项目文档git分开使用。

​		建议：(1)小项目尽量所有系统的源代码放一个仓库，方便统一管理。

​					(2)大项目可根据各系统之间的关联性复杂度和系统规模划分多个git进行管理。

​		②提交git申请：git资源的申请由研发经理或者研发负责人向配置管理组人员提供项目有关信息进行申请。

​		③获取git地址：提交申请后，配置管理员按照要求创建好git之后会反馈初始化（**master分支此时创建**）后的git访问地址。

​	注：负责政法委开发部配置管理人是肖飒。

### git成员加入

​	①由申请者向主成人员或者负责人（拥有maintainer角色的人）进行申请加入git资源

​	②研发经理或者负责人在人员在Settings->Members中搜索账号或域名设置角色并添加后通知申请人。

###  develop分支创建

​		在初始化后，可基于master分支创建一个新的分支，名称为develop分支，之后所有功能分支基于develop分支创建feature

此过程一般由研发经理或者系统负责人进行，需要进行如下步骤：

​	①创建develop分支；

​	②将master分支设置为受保护分支。注：关于保护分支的设置，可以进入Settings->Repository->Protected branches进行管理

##  git分支管理规范

以具体的项目开发流程为例，从系统需求，功能实现，软件测试，实施运维四个阶段，展示各分支的生命周期和活动状态

### 需求阶段

需求阶段git操作只是提前进行git分支的规划及分支创建，未涉及代码层级的变动，一般git提交及活动量极小

####  git开发模型选定

在需求传递后，根据工作量大小，选定git分支模型

选定模型方式：1. 由研发经理或者主成人员决定分支模型；2. 研发内部达成一致，选定模型。

#### Git功能分支/版本分支创建

基于develop分支创建新的分支，分支命名规则为：

1.如果是基于功能模型，创建分支以develop为基础，feature_功能名称首字母简写命名分支。

例如：涉案此物功能的分支创建为：feature_sacw

\2. 如果是基于版本模型，创建分支以develop为基础，feature_版本发布名称命名。

例如：协同办案子系统V1.0分支创建为：feature_协同办案子系统v1.0

 

注：1.创建分支前下拉取中央仓库最新代码到本地再创建分支2.创建分支不论是那种模式，分支命名规则统一。分支中间分隔符为下划线_ 所有字母均为小写。

 

### 开发阶段

在功能发开工程中，代码每天不断更新，本地和中央仓库不断进行代码同步，此阶段是git最为活跃的时间段。Git使用最为频繁的操作为：拉取，提交 推送操作。

####  Git分支切换

功能分支/版本分支创建成功后，更新本地代码至最新，本地检出至4.1.2中切换的分支。该功能/版本分支分支贯穿整个阶段。

#### Jenkins自动化构建分支配置

在系统功能或者版本开发完成后，提交本地最新代码至中央仓库，

配置自动化构建，统一交给jenkins打包处理，在构建配置时需要配置成对应的功能或者版本的分支。

#### Sonar静态代码检查分支配置

Jekins构建配置中sonar地址配置成公司sonar地址，检查分支需要配置成当前对应的功能或者版本分支，点击构建。

构建完成邮件中静态代码检查结果地址需要修改配置成jenkins构建成功后，需要查看控制台日中的构建结果，找到sonar地址（此地址具有分支信息），更改jenkis中配置完成中的sonar邮件地址。

注：每天至少进行一次本地和远程代码的同步，减少冲突，也避免长时间未更新代码导致代码丢失的情况[[18\]](#_msocom_18) 

## 测试阶段

### 功能分支

如果采用功能模型的分支进行开发，在功能测试完成后，稳定测试开始前进行如下操作：

a)     合并分支至develop，[[20\]](#_msocom_20) 在各功能测试完成后，需要将其完成测试的所有功能分支进行合并，将其没有问题的功能分支别分合并到develop上。

b)     删除该功能分支

c)     所有功能开发人员合并完成后通知系统发布及提测人员，提测人员同步代码至最新，

基于develop创建新的release分支

分支名称统一命名为：release_系统发布名称，例如：release_协同办案子系统1.0 

注：1.创建release分支确保两件事，第一：是否本次发布的所有功能均已经合并到develop，第二：本版本发布是基于哪个分支发布，基础版本的代码是否已经合并到develop2.分支名称中间分隔符为下划线_ 所有字母均为小写

d)     配置新创建的release分支上的jenkins构建和sonar代码检查

e)     在稳定测试后，将其release分支同步合并到master分支和develop分支。

如果合并分支人员不是mainiater角色

1.本地更新代码至最新，本地合并，并解决冲突。2.提交和并请求至主成或者负责人3.负责人或主成同意和并请求，代码自动合并。4.合并成功后，删除release分支。

f)     创建tag标签，标签命名规则：系统发布名称。例如：协同办案子系统V1.0。方便之后快速定位版本。

###  版本分支

如果采用版本分支模型的话，从功能开发到版本发布，都一直沿用这一个分支，但各阶段还是需要进行检查。

a)     基础版本检查：在测试前，需要确认本版本发布是基于哪个分支发布，该分支是否在基础版本的分支合并之后打出的版本分支。如果是在基础版本合并之前打出的版本分支，则需要将develop分支/基础版本分支内容重新合并到本分支，然后进行测试。

b)     自动化构建和静态代码检查配置：提测前进行jenkins的分支配置和sonar的分支配置。

c)     分支合并：在功能测试和稳定测试完成后将版本分支代码合并到masters和develop上。

如果合并分支人员不是mainiater角色

1.本地更新代码至最新，本地合并，并解决冲突。2.提交和并请求至主成或者负责人3.负责人或主成同意和并请求，代码自动合并。

d)     合并成功后，删除版本分支。

e)     创建tag标签，标签命名规则：系统发布名称。例如：协同办案子系统V1.0。方便之后快速定位版本。

## 运维保障阶段

如果上线后出现功能缺陷，则需要进行补丁修复。

a)     基于线上版本号，锁定tag标签。

b)     根据tag标签，回滚master分支到指定tag版本。

c)     基于回滚后的master创建补丁修复分支，命名规则为gotfix_协同办案子系统v1.0_build+序号。gotfix_协同办案子系统v1.0_build_001

d)     修改问题及测试全基于当前分支进行，缺陷解决后，将hotfix分支合并至master和develop分支上。

e)     合并成功后，删除缺陷分支。

f)     创建新的tag，标签命名规则：系统发布名称_bulid+序号。例如：协同办案子系统v1.0_bulid001，方便之后快速定位版本。

 

------


